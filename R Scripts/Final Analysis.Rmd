---
title: "Final Analysis"
author: "Hayden Green"
date: "3 April 2019"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}

library(tidyverse)
library(readxl)
library(lme4)
library(lmerTest)
library(psych)
library(ggplot2)
library(ggthemes)
library(ggridges)
library(ez)
library(sjPlot)
library(knitr)
library(Hmisc)
library(broom)
```

## R Markdown


```{r results='hide', warning=FALSE, error=FALSE}

saccades_database <- read_csv("G:\\Team Drives\\Research Team\\Projects\\2018 Driving Sim Reproducibility\\4_Analysis_Saccades\\Individual_saccade_database.csv")

driving_perf_by_distance <- read_csv("G:\\Team Drives\\Research Team\\Projects\\2018 Driving Sim Reproducibility\\binned_by_dist_100_final.csv")

driving_perf_by_saccade <- read_csv("G:\\Team Drives\\Research Team\\Projects\\2018 Driving Sim Reproducibility\\binned_by_saccade_100_final.csv")

## ER is missing all trials requiring a right trigger response in Fam S1    
attention_performance_database <- read_csv("G:\\Team Drives\\Research Team\\Projects\\2018 Driving Sim Reproducibility\\task_response_database.csv") %>% 
            select(ID, Session, Run, `trial number`, task_condition, task_arrow_dir, stimulus_left_right, congruency, target_deviation, response_type,
                   reaction_time)

# creates a file where task performance data is given to the saccade data
saccade_attn_joined <- saccades_database %>% 
                        left_join(attention_performance_database, 
                                  by = c("ID","Session","Run","trial number")) %>% 
                        select(ID,Session,Run,`trial number`,condition, task_condition, eye, 
                               stimulus_left_right, task_arrow_dir, congruency,target_deviation,
                               `correct direction`, duration, `dva/s`, `peak_dva/s`, amplitude, saccade_size, `stimulus onset delay`,
                               reaction_time, response_type) 

KSS_data <- read_excel(path = "G:\\Team Drives\\Research Team\\Projects\\2018 Driving Sim Reproducibility\\KSS Scores.xlsx", sheet = 1) %>%
                select(1:7) %>% gather(key = "Timepoint", value =  "kss_score", Baseline, Run_1, Run_2, Run_3, Run_4) %>% filter(kss_score != "NA") %>% as.tibble()

KSS_data$kss_score <- KSS_data$kss_score %>% as.numeric()
KSS_data$Timepoint <- KSS_data$Timepoint %>% as.factor()

```


#Plotting and summary of the KSS Data


```{r, echo=FALSE}


KSS_data %>% select(Session,Timepoint, Participant_ID,kss_score) %>%
    group_by(Session, Timepoint) %>% 
    summarise(mean = mean(kss_score), sd = sd(kss_score),sem = sd(kss_score)/sqrt(n())) %>%
    ggplot(aes(x = Timepoint, y= mean, shape = Session, group = Session)) +
    geom_point() +
    geom_line() +
    labs(title = "KSS Scores",
         x = " Timepoint",
         y = "Mean KSS Score") +
    scale_y_continuous(limits = c(1,9), breaks = c(1,2,3,4,5,6,7,8,9), expand = c(0,0)) +
    scale_x_discrete(labels = c("Baseline","Run 1","Run 2", "Run 3","Run 4"))+
    geom_errorbar(aes(ymin = mean - sem, ymax = mean + sem, width = .1)) +
    theme_classic()
    

kss_summary <- KSS_data %>% select(Session,Timepoint, Participant_ID,kss_score) %>%
    group_by(Session, Timepoint) %>% 
    summarise(mean = mean(kss_score), sd = sd(kss_score),sem = sd(kss_score)/sqrt(n()))

kss_fit <- aov(kss_score ~ Session * Timepoint, data = KSS_data)
print(summary(kss_fit))
plot(kss_fit)
kss_lm <- lm(kss_score ~ Session * Timepoint, data = KSS_data)
tidy(kss_lm)
```


#Plotting and analysis of Drivesim Data

```{r}
driving_perf_by_distance$Trial <- driving_perf_by_distance$Trial %>% as.character()


driving_perf_by_distance %>% group_by(Trial, Run, bin_number) %>% select (7:16) %>% summarise_at(vars(avg_speed:sd_steering),list(mean = ~mean(.),sd = ~sd(.),sem = (~sd(.)/sqrt(n())))) %>% arrange(Trial)

drive_perf_summary <- driving_perf_by_distance %>% group_by(Trial, Run, bin_number) %>% select (7:16) %>% summarise_at(vars(avg_speed:sd_steering),list(mean = ~mean(.),sd = ~sd(.),sem = (~sd(.)/sqrt(n())))) %>% mutate(Timepoint = str_c(Trial,Run, sep = "_" )) %>% filter(bin_number > 3)


drive_perf_summary %>% ggplot(aes(x = bin_number, y = avg_speed_mean, 
                                  group = Timepoint, shape = Timepoint, 
                                  colour = Timepoint)) +
    geom_point() +
    geom_line() +
    labs(title = "Average Speed",
         x = "Bin Number",
         y = "Average Speed (km/h)") +
    geom_errorbar(aes(ymin = avg_speed_mean - avg_speed_sem, ymax = avg_speed_mean + avg_speed_sem, width = .1)) +
    theme_classic()


drive_perf_summary %>% ggplot(aes(x = bin_number, y = avg_lanepos_mean, 
                                  group = Timepoint, colour = Timepoint, shape = Timepoint)) +
                        geom_point() +
                        geom_line() +
                        geom_smooth( alpha = 0.3)+
                        labs(title = "Lane Position",
                             x = "Bin Number",
                             y = "Lane Position m")
                        theme_classic()
    
```


```{r}

```

