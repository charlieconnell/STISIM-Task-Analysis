---
title: "Reliability Analysis"
author: "Hayden Green"
date: "11 October 2018"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(tidyselect)
library(ggthemes)
library(ggridges)
library(xlsx)
library(psy)
library(psych)
library(irr)
library(ez)
library(data.table)

file_to_import <- list.files(path = "G:/Team Drives/Research Team/Projects/2018 Driving Sim Reproducibility/", pattern = "?KSS Scores.xlsx", recursive = TRUE, full.names = TRUE)

KSS_scores <- read_excel("G:/Team Drives/Research Team/Projects/2018 Driving Sim Reproducibility/KSS Scores.xlsx")

KSS_scores %>% head()

gathered <- KSS_scores %>% gather(Baseline:Run_4, key = "Variable", value = "value")
gathered$Variable <- gathered$Variable %>% as.character() 

na_removed <- gathered %>% 
  filter(value != "NA") %>% 
  filter(Variable != "Run_3"| Variable != "Run_4") 
na_removed$value <- na_removed$value %>% as.numeric()

na_removed %>% head()

```


```{r}

KSSfit1 <- aov(value ~ Session*Variable + Participant_ID, na_removed)
summary(KSSfit1)

ezANOVA(na_removed, dv = value, wid = Participant_ID, within = .(Variable, Session), detailed = TRUE)


```

```{r, results = 'hide'}

binned_files_saccade <- list.files(path = "G:/Team Drives/Research Team/Projects/2018 Driving Sim Reproducibility/", pattern = "?binned_by_saccade_100", recursive = TRUE, full.names = TRUE)

binned_files_distance <- list.files(path = "G:/Team Drives/Research Team/Projects/2018 Driving Sim Reproducibility/", pattern = "?binned_by_dist_100", recursive = TRUE, full.names = TRUE)


database_by_saccade_100 <- binned_files_saccade %>% map_df(~read_csv(., col_types = "dddddddddddddddddcccccc"))

database_by_distance_100 <- binned_files_distance %>% map_df(~read_csv(., col_types = "iiddddddddddddddd??c?c"))


database_by_saccade_100 <- binned_files_saccade %>% map_df(~fread(., stringsAsFactors = TRUE, colClasses=c()))

database_by_distance_100 %>% write.csv(file.choose())

database_by_saccade_100 %>% write.csv(file.choose())


 
x <- binned_files_distance %>% map_df(~create_database(.))
x$Run <- x$Run %>% as.factor()



create_database <- function (x) {
  df <- read_csv(x, col_types = "???????????????????c?d?")

  df$ID <- df$ID %>% as.character()
  df$File_Number <- df$File_Number %>% as.double()
  df$Date <- df$Date %>% as.Date()
  df$Trial <- df$Trial %>% as.character()
  df$Run <- df$Run %>% as.character()
  
 df1 <- df %>% filter(start_dist < 30001, start_dist > 299)
 
 df1 
    }


Fam <- x %>% filter(Trial == "F" & Run == 1) %>% arrange(ID, Run, bin_number) %>% 
  select(ID, Run, bin_number, sd_speed, avg_lanepos)

T1_R1 <- x %>% filter(Trial == "1" & Run == 1) %>% arrange(ID,Run,bin_number) %>% 
  select(ID, Run, bin_number, sd_speed, avg_lanepos)

T1_R2 <- x %>% filter(Trial == "1" & Run == 2) %>% arrange(ID,Run,bin_number) %>% 
  select(ID, Run, bin_number, sd_speed, avg_lanepos)

T2_R1 <- x %>% filter(Trial == "2" & Run == 1) %>% arrange(ID,Run,bin_number) %>% 
  select(ID, Run, bin_number, sd_speed, avg_lanepos)

T2_R2 <- x %>% filter(Trial == "2" & Run == 2) %>% arrange(ID,Run,bin_number) %>% 
  select(ID, Run, bin_number, sd_speed, avg_lanepos)


Fam <- Fam %>% group_by(ID) %>% summarise(min = min(bin_number), max = max(bin_number), mean_lanesd = mean(sd_speed))
T1_R1 <- T1_R1 %>% group_by(ID) %>% summarise(min = min(bin_number), max = max(bin_number), mean_lanesd = mean(sd_speed))
T1_R2 %>% group_by(ID,bin_number) %>% summarise(min = min(bin_number), max = max(bin_number), mean_lanesd = mean(sd_speed))
T2_R1 %>% group_by(ID,bin_number) %>% summarise(min = min(bin_number), max = max(bin_number), mean_lanesd = mean(sd_speed))
T2_R2 %>% group_by(ID,bin_number) %>% summarise(min = min(bin_number), max = max(bin_number), mean_lanesd = mean(sd_speed))

```


```{r}
##ridgeline plot with median upper and lower quartiles, can change stat_density_ridges(quantile_lines = TRUE, quantiles = c() ) and then 
p1 <- ggplot(x, aes(x = avg_lanepos, y = Trial, height = ..density.., fill = Run)) +
    stat_density_ridges(quantile_lines = TRUE, alpha = 0.9, scale = .9) +
  theme_minimal()
p1
# an alternative ridgeline plot with data points recorded can use in aes(color = Run_Number once correctly labelled run number to 1 or two)


  p2 <- ggplot(x, aes(x = sd_speed, y = Trial, color =  height = ..density..)) +
  geom_density_ridges(jittered_points = TRUE, quantile_lines = TRUE, scale = 0.9, 
                      alpha = 0.5, vline_size = .8, vline_color = "blue", point_size = 0.4,
                      position = position_raincloud(adjust_vlines = FALSE)) +
  theme_classic()
plot(p2)


ridgeline_with_dots(df = x, variable_to_show = sd_speed)



p3 <- ggplot(x, aes(x = avg_lanepos, y = Trial, color = Run, point_color = Run, fill = Run, height = ..density..)) + geom_density_ridges(jittered_points = TRUE, quantile_lines = TRUE, scale = 0.7, 
                      alpha = 0.5, vline_size = .5, vline_color = c("black"), point_size = 0.4,
                      position = position_raincloud(adjust_vlines = FALSE)) +
         scale_color_canva()+
    stat_density_ridges(quantile_lines = TRUE, alpha = 0.2, scale = .7) +
  theme_base()
 
p3


```
```{r}

ICCtester <- data.frame(Fam$mean_lanesd, T1_R1$mean_lanesd)

psych::ICC(ICCtester)



blandr.display.and.draw(Fam$avg_lanepos,T1_R1$avg_lanepos)
```

