---
title: "Binning Drivesim Data"
author: "Hayden Green"
date: "6 August 2018"
output: html_document
---

## Function to Bin the Drivesim data into chunks of equal distance
  The function requires the Bin size otherwise the default will be 100m,


```{r results='hide'}
library(tidyverse)
library(tidyselect)
library(ggthemes)
library(ggridges)

List_of_checked_files <- read.xlsx(filename_Database, sheetIndex = 1) %>% 
  mutate(pattern_name = paste0(Participant,"_", Run_Number))


Imported <- read_csv(file.choose(), col_names = TRUE, col_types = "ddddddddddddddddddddddddtcdTcc") %>% as.tibble()

#The function used to create the bins, bin size by default is every 100m  
bin_by_dist <- function(x, bin_size = 100) {
    #Check to see data structure and contents is sufficient for the binning function. 
  
  if(class(x) != "data.frame") {
      stop("Object is Not Data Frame")
  }
  if(!"Total_dist" %in% names(x)){
      stop("No distance column in data frame")
  }
  ##pop up to confirm whether the file was from the country or urban task. 
 Task <- if_else(x$scenario[1] == "Urban", 1,2)
    
  max_bin <- if_else(Task == 1, 31000, 9000)
  
  bins <- c(seq(from = 100, to = max_bin,by= bin_size))

  
  bin_start  <-  seq(from = 100, to = max_bin - bin_size, by = bin_size)
  bin_end    <-  seq(from = 100 + bin_size, to = max_bin, by = bin_size)
  bin_ranges <-  paste(bin_start,"-", bin_end, sep = "")

  binned_data <<- data.frame(bin_start, bin_end, bin_ranges)
  names(binned_data) <- c("bin_start","bin_end", "bin_ranges")
  
  bin_factors <<- as.factor(cut(x$Total_dist, breaks =  binned_data$bin_start, labels = FALSE))
  
  x %>% 
    mutate(bin_num = bin_factors) %>%
    group_by(bin_num) %>% 
    summarise(bin_duration = max(Elapsed_Time) - min(Elapsed_Time),
              avg_speed = mean(Speed), 
              sd_speed = sd(Speed),
              avg_lanepos = mean(Lateral_Lane_Pos), 
              sd_lanepos = sd(Lateral_Lane_Pos),
              avg_throttle = mean(Throttle_input), 
              sd_throttle = sd(Throttle_input))
  
  
}


```

```{r}

bin_by_saccades <- function(x, bin_size = 100) {
   if(class(x) != "data.frame") {
      stop("Object is Not Data Frame")
  }
  if(!"Total_dist" %in% names(x)){
      stop("No distance column in data frame")
  }
  saccades <- seq(from = 250, to = 30000, by = 250)
  saccade_number <- seq(from = 1, to = 120, by = 1)
  saccade_bin_start <- saccades - bin_size
  saccade_bin_end <- saccades + bin_size
  saccade_bin_ranges <-  paste(saccade_bin_start,"-", saccade_bin_end, sep = "")
  
  binned_data <- data.frame(saccade_bin_start, saccade_bin_end, saccade_bin_ranges, saccade_number)
  names(binned_data) <- c("bin_start","bin_end", "bin_ranges")
  
  bin_factors <- as.factor(cut(x$Total_dist, breaks =  binned_data$bin_start, labels = FALSE))

   x %>% 
    mutate(bin_num = bin_factors) %>%
    group_by(bin_num) %>% 
    summarise(bin_duration = max(Elapsed_Time) - min(Elapsed_Time),
              avg_speed = mean(Speed), 
              sd_speed = sd(Speed),
              avg_lanepos = mean(Lateral_Lane_Pos), 
              sd_lanepos = sd(Lateral_Lane_Pos),
              avg_throttle = mean(Throttle_input), 
              sd_throttle = sd(Throttle_input))
}
```


```{r}

save_data <- function(x) {
  save_location <- str_replace(file_to_check, "trimmed", "checked")   
  existing_file <- if_else(file.exists(save_location), TRUE, FALSE) 
  code <- paste0(x$ID[1] %>% as.character(),"_" ,x$Run_Number[1] %>% as.character())
  if(existing_file == TRUE) {
     overwrite <- menu(c("Overwrite","Stop"), graphics = TRUE, title = "trimmed csv data already exists do you wish to overwrite") %>% as.numeric()
     if(overwrite == 2) {
       stop("ERROR:: file already exists")
      } else {
       write.csv(x, file = save_location, row.names = FALSE)
       print(paste0(code,"_checked.csv is saved"))
  } } 
    else if (existing_file == FALSE) {
  write.csv(x, file = save_location, row.names = FALSE)
  return(paste0(code,"_checked.csv is saved")) 
    } else {
    stop("ERROR :: error in saving process save manually")
        }
  } 

```



```{r}
output <- as.tibble(bin_by_saccades(Imported) %>% filter(bin_duration > 0, !is.na(bin_num)))
output <- as.tibble(bin_by_dist(Imported) %>% filter(bin_duration > 0, !is.na(bin_num)))
output2 <- output %>% mutate(Trial = as.factor("Fam"))
output3 <- output %>% mutate(Trial = as.factor("1"))
output4 <- output2 %>% bind_rows(output3)
output4$Trial <- output4$Trial %>% as.factor()
```




```{r}
##ridgeline plot with median upper and lower quartiles, can change stat_density_ridges(quantile_lines = TRUE, quantiles = c() ) and then 
p1 <- ggplot(output4, aes(x = avg_speed, y = Trial, height = ..density..)) +
    stat_density_ridges(quantile_lines = TRUE, alpha = 0.9, scale = .9)+
  xlim(60,120)
p1
# an alternative ridgeline plot with data points recorded
p2 <- ggplot(output4, aes(x = avg_speed, y = Trial, height = ..density..)) +
  geom_density_ridges(jittered_points = TRUE, quantile_lines = TRUE, scale = 0.8, 
                      alpha = 0.5, vline_size = .8, vline_color = "blue", point_size = 0.4,
                      position = position_raincloud(adjust_vlines = FALSE)) +
  theme_classic()
p2

```

```{r}


```

